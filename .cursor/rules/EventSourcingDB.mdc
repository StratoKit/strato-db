# EventSourcingDB & ESModel Modules (`src/EventSourcingDB`)

These modules implement the core event sourcing pattern for the database.

## Core Components

### `EventSourcingDB.js` (`EventSourcingDB` class)

- **Purpose:** Orchestrates the event sourcing process. It manages the flow of events from the `EventQueue` to the `ESModel` instances, ensuring atomic and ordered processing.
- **Key Features:**
    - **Event Loop:** Polls or waits for new events from the `EventQueue`.
    - **Event Processing Pipeline:** For each event:
        1.  **Preprocessing:** Calls `preprocessor` static methods on all registered `ESModel`s. `ESModel.preprocessor` assigns IDs to new objects.
        2.  **Reduction:** Calls `reducer` static methods on all `ESModel`s. `ESModel.reducer` calculates the necessary change (`ins`, `upd`, `rm`, `esFail`) based on the event type and current state.
        3.  **Application:** Within a database transaction:
            - Calls `applyResult` (via `model.applyResult(result)` which calls the imported `applyResult`) on each model with its calculated result, making the actual database changes using the underlying `JsonModel` methods (in writable mode).
            - Calls `deriver` methods on models for post-processing (also in writable mode).
        4.  **Commit:** Commits the transaction and updates the database `user_version`.
    - **Sub-events:** Handles events dispatched *during* the processing of another event, processing them recursively within the same transaction.
    - **Error Handling:** Logs errors and halts processing if a reducer or applicator fails. Stores error information in the event's `result` field in the `EventQueue`.
    - **State Management:** Manages database connections (potentially separate R/W and RO), tracks the current processed version, and uses `AsyncLocalStorage` for context.
    - **Lifecycle Events:** Emits events ('begin', 'result', 'error', 'processed') for monitoring.
- **Dependencies:** `DB`, `EventQueue`, `ESModel`, `debug`, `lodash`, `AsyncLocalStorage`.

### `ESModel.js` (`ESModel` class)

- **Purpose:** A wrapper around `JsonModel` that integrates a model into the event sourcing system.
- **Key Features:**
    - **Extends `JsonModel`:** Inherits ORM capabilities.
    - **Event Generation:** Overrides `set`, `update`, `remove` to dispatch standardized events (`{type: 'es/ModelName', data: [...]}`) instead of directly modifying the DB.
    - **Standard Event Format:** Uses `[ACTION_ENUM, id, payload, meta]` for event `data`.
    - **Writable Mode (`setWritable`)**: Allows bypassing event generation for direct DB modification (used by `applyResult`, migrations, derivers).
    - **Event Helpers (`event.*`)**: Provides methods to easily create standard event objects.
    - **Default Handlers:** Implements static `preprocessor` (assigns IDs) and `reducer` (calculates `ins`/`upd`/`rm`/`esFail`) for the standard `es/ModelName` events.
    - **ID Prediction (`getNextId`)**: Predicts the next integer ID within a processing cycle.
- **Dependencies:** `JsonModel`, `applyResult.js`, `lodash`, `debug`.

### `applyResult.js`

- **Purpose:** A utility function used by `ESModel.applyResult`.
- **Key Features:** Takes a model instance (in writable mode) and a result object (e.g., `{ins: [...], upd: [...], rm: [...]}`) generated by a reducer, and calls the appropriate underlying `JsonModel` methods (`_set`, `remove`) to apply the changes to the database.
- **Dependencies:** `JsonModel` (implicitly via the model instance).

## Usage

1.  Define models by extending `ESModel` or using it directly, passing a `dispatch` function from `EventSourcingDB`.
2.  Instantiate `EventSourcingDB`, providing it with an `EventQueue` instance (or configuration) and a map of `models`.
3.  Call `esdb.open()` and `esdb.startPolling()` (or `waitForQueue`).
4.  Interact with the database *only* through `ESModel` methods (`set`, `update`, `remove`) or by directly dispatching events via `esdb.dispatch()`. The system handles processing these events asynchronously.
5.  Use standard `JsonModel` methods for reads (`get`, `search`, etc.).

## Structure

```
src/
└── EventSourcingDB/
    ├── EventSourcingDB.js # Main orchestrator class
    ├── ESModel.js         # JsonModel wrapper for event sourcing
    ├── applyResult.js     # Utility to apply reducer results
    ├── ES*.test.js        # Unit tests
    └── index.js           # Module entry point
```
